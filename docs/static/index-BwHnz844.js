import{_ as le,C as ae,d as ne,u as ue,r as _,y as m,v as ie,w as U,c as r,f as e,k as S,F as M,D as T,A as a,G as z,H as h,I as b,s as de,t as ce,m as g,o as v,J as re}from"./index-Lq3EucIc.js";import{l as ve}from"./productInventory-BN_jAqQY.js";import{l as pe}from"./couponsUserManage-Dh_ONEl7.js";import{l as _e}from"./couponsManage-DEnfi_HX.js";import{a as me}from"./userOrders-BIeY2I1m.js";const l=N=>(de("data-v-71793b05"),N=N(),ce(),N),he={class:"order-container"},fe=l(()=>e("div",{class:"page-title"},"创建订单",-1)),ye={class:"order-section"},be=l(()=>e("h3",{class:"section-title"},"选择出行日期",-1)),Ie={class:"date-selector"},ge=["onClick"],ke={class:"date-info"},Ce={class:"departure-date"},Ne={class:"price-info"},xe={class:"stock-info"},qe={key:0,class:"empty-tip"},Ve={class:"order-section"},Pe={class:"section-header"},Ae=l(()=>e("h3",{class:"section-title"},"出行人信息",-1)),Se={class:"add-traveler"},Ee=["disabled"],$e=["disabled"],we={key:0,class:"empty-tip"},De={class:"form-row"},Fe={class:"form-item"},Le=l(()=>e("label",null,[g("姓名 "),e("span",{class:"required"},"*")],-1)),Ue=["onUpdate:modelValue"],Me={class:"form-item"},Te=l(()=>e("label",null,[g("性别 "),e("span",{class:"required"},"*")],-1)),ze=["onUpdate:modelValue"],Oe=l(()=>e("option",{value:"1"},"男",-1)),Be=l(()=>e("option",{value:"2"},"女",-1)),Re=[Oe,Be],je={class:"form-row"},Ge={class:"form-item"},He=l(()=>e("label",null,[g("出生日期 "),e("span",{class:"required"},"*")],-1)),Je=["onUpdate:modelValue"],Ke={class:"form-item"},We=l(()=>e("label",null,[g("护照号码 "),e("span",{class:"required"},"*")],-1)),Xe=["onUpdate:modelValue"],Ye={class:"form-row"},Ze={class:"form-item"},Qe=l(()=>e("label",null,[g("护照有效期 "),e("span",{class:"required"},"*")],-1)),et=["onUpdate:modelValue"],tt={class:"form-actions"},st=["onClick","disabled"],ot=l(()=>e("hr",null,null,-1)),lt={key:1,class:"error-tip"},at={class:"order-section"},nt=l(()=>e("h3",{class:"section-title"},"选择优惠券",-1)),ut={class:"coupon-list"},it=["onClick"],dt={class:"coupon-info"},ct={class:"coupon-code"},rt={class:"coupon-desc"},vt={key:0},pt={key:1},_t={class:"coupon-validity"},mt={class:"coupon-selector"},ht=["checked","disabled"],ft={key:0,class:"empty-tip"},yt={class:"order-section"},bt=l(()=>e("h3",{class:"section-title"},"联系人信息",-1)),It={class:"contact-form"},gt={class:"form-row"},kt={class:"form-item"},Ct=l(()=>e("label",null,[g("联系人姓名 "),e("span",{class:"required"},"*")],-1)),Nt={class:"form-item"},xt=l(()=>e("label",null,[g("联系电话 "),e("span",{class:"required"},"*")],-1)),qt={class:"form-row"},Vt={class:"form-item full-width"},Pt=l(()=>e("label",null,"联系邮箱",-1)),At={class:"form-row"},St={class:"form-item full-width"},Et=l(()=>e("label",null,"订单备注",-1)),$t={class:"order-summary"},wt={class:"summary-item"},Dt=l(()=>e("span",null,"成人数量:",-1)),Ft={class:"summary-item"},Lt=l(()=>e("span",null,"儿童数量:",-1)),Ut={class:"summary-item"},Mt=l(()=>e("span",null,"总价:",-1)),Tt={class:"summary-item discount"},zt=l(()=>e("span",null,"优惠金额:",-1)),Ot={class:"summary-item total"},Bt=l(()=>e("span",null,"实付金额:",-1)),Rt=["disabled"],jt=ae({name:"purchase"}),Gt=Object.assign(jt,{setup(N){const{proxy:x}=ne(),I=ue(),q=_(null),V=_(null),P=_([]),E=_([]),O=_([]),f=_(null),i=_(null),d=_([]),n=_({contactName:"",contactPhone:"",contactEmail:"",note:""});function B(t){ve({pageNum:1,pageSize:1e3,productId:t,isActive:1}).then(o=>{P.value=o.rows})}function R(t){pe({pageNum:1,pageSize:1e3,userId:t}).then(o=>{E.value=o.rows})}function Q(){_e({pageNum:1,pageSize:1e3}).then(t=>{O.value=t.rows})}function ee(t){f.value=t.inventoryId,i.value=null}function j(t){d.value.push({isAdult:t,realName:"",gender:1,birthdate:"",passportNumber:"",passportExpiry:""})}function te(t){d.value.splice(t,1)}function G(t){if(!t){i.value=null;return}L(t)&&(i.value=t.id)}function y(t){return O.value.find(o=>o.couponId===t)}const $=m(()=>d.value.filter(t=>t.isAdult===1).length),w=m(()=>d.value.filter(t=>t.isAdult===0).length),A=m(()=>d.value.length),p=m(()=>P.value.find(t=>t.inventoryId===f.value)),D=m(()=>E.value.find(t=>t.id===i.value)),k=m(()=>p.value?$.value*p.value.adultPrice+w.value*p.value.childPrice:0),F=m(()=>{if(!D.value)return 0;const t=y(D.value.couponId);return!t||k.value<t.minPurchase?0:t.type===0?t.value:Math.floor(k.value*(1-t.value))}),H=m(()=>{const t=k.value-F.value;return t<0?0:t}),J=m(()=>E.value.filter(t=>{const o=y(t.couponId);return t.status===0&&(o==null?void 0:o.isActive)===1}));function L(t){const o=y(t.couponId);return o?k.value>=o.minPurchase:!1}const K=m(()=>{if(!f.value||d.value.length===0)return!1;for(const t of d.value)if(!t.realName||!t.birthdate||!t.passportNumber||!t.passportExpiry)return!1;return!(!n.value.contactName||!n.value.contactPhone||A.value>p.value.availableStock)});function se(){if(!K.value)return;const t={userId:q.value,productId:V.value,inventoryId:f.value,departureDate:p.value.departureDate,adultCount:$.value,childCount:w.value,totalAmount:k.value,discountAmount:F.value,paymentAmount:H.value,contactName:n.value.contactName,contactPhone:n.value.contactPhone,contactEmail:n.value.contactEmail,note:n.value.note,couponUserId:i.value,travelers:d.value.map(u=>({isAdult:u.isAdult,realName:u.realName,gender:u.gender,birthdate:u.birthdate,passportNumber:u.passportNumber,passportExpiry:u.passportExpiry}))},o=_();me(t).then(u=>{u.code===200?(x.$message.success("订单创建成功，即将前往支付"),o.value=u.data,oe(),x.$router.push({path:"/payment",query:{orderId:o.value.orderId,paymentAmount:o.value.paymentAmount}}),console.log("订单创建成功",o.value)):x.$message.error("订单创建失败："+(u.msg||"未知错误"))}).catch(u=>{x.$message.error("提交订单出错："+u.message)})}function oe(){f.value=null,i.value=null,d.value=[],n.value={contactName:"",contactPhone:"",contactEmail:"",note:""}}return ie(()=>{Q(),I.query.productId&&(V.value=I.query.productId,B(I.query.productId)),I.query.userId&&(q.value=I.query.userId,R(I.query.userId))}),U(()=>I.query,t=>{t.productId&&t.productId!==V.value&&(V.value=t.productId,B(t.productId),f.value=null),t.userId&&t.userId!==q.value&&(q.value=t.userId,R(t.userId),i.value=null)}),U(f,()=>{i.value=null}),U(d,()=>{i.value&&!L(D.value)&&(i.value=null)},{deep:!0}),(t,o)=>{var u,W;return v(),r("div",he,[fe,e("div",ye,[be,e("div",Ie,[(v(!0),r(M,null,T(P.value,s=>(v(),r("div",{key:s.inventoryId,class:z(["date-item",{active:f.value===s.inventoryId}]),onClick:C=>ee(s)},[e("div",ke,[e("div",Ce,a(s.departureDate),1),e("div",Ne," 成人价: ¥"+a(s.adultPrice.toFixed(2))+" | 儿童价: ¥"+a(s.childPrice.toFixed(2)),1),e("div",xe," 剩余库存: "+a(s.availableStock),1)])],10,ge))),128)),P.value.length===0?(v(),r("div",qe,"暂无可用日期")):S("",!0)])]),e("div",Ve,[e("div",Pe,[Ae,e("div",Se,[e("button",{onClick:o[0]||(o[0]=s=>j(1)),disabled:A.value>=((u=p.value)==null?void 0:u.availableStock)}," 添加成人 ",8,Ee),e("button",{onClick:o[1]||(o[1]=s=>j(0)),disabled:A.value>=((W=p.value)==null?void 0:W.availableStock)}," 添加儿童 ",8,$e)])]),d.value.length===0?(v(),r("div",we,"请至少添加一名出行人")):S("",!0),(v(!0),r(M,null,T(d.value,(s,C)=>(v(),r("div",{key:C,class:"traveler-form"},[e("div",De,[e("div",Fe,[Le,h(e("input",{type:"text","onUpdate:modelValue":c=>s.realName=c,placeholder:"请输入真实姓名",required:""},null,8,Ue),[[b,s.realName]])]),e("div",Me,[Te,h(e("select",{"onUpdate:modelValue":c=>s.gender=c},Re,8,ze),[[re,s.gender]])])]),e("div",je,[e("div",Ge,[He,h(e("input",{type:"date","onUpdate:modelValue":c=>s.birthdate=c,required:""},null,8,Je),[[b,s.birthdate]])]),e("div",Ke,[We,h(e("input",{type:"text","onUpdate:modelValue":c=>s.passportNumber=c,placeholder:"请输入护照号码",required:""},null,8,Xe),[[b,s.passportNumber]])])]),e("div",Ye,[e("div",Ze,[Qe,h(e("input",{type:"date","onUpdate:modelValue":c=>s.passportExpiry=c,required:""},null,8,et),[[b,s.passportExpiry]])]),e("div",tt,[e("button",{type:"button",class:"delete-btn",onClick:c=>te(C),disabled:d.value.length<=1}," 删除 ",8,st)])]),ot]))),128)),p.value&&A.value>p.value.availableStock?(v(),r("div",lt," 出行人总数不能超过剩余库存 ("+a(p.value.availableStock)+") ",1)):S("",!0)]),e("div",at,[nt,e("div",ut,[(v(!0),r(M,null,T(J.value,s=>{var C,c,X,Y,Z;return v(),r("div",{key:s.id,class:z(["coupon-item",{selected:i.value===s.id}]),onClick:Ht=>G(s)},[e("div",dt,[e("div",ct,a(s.code),1),e("div",rt,[((C=y(s.couponId))==null?void 0:C.type)===0?(v(),r("span",vt," 满"+a((c=y(s.couponId))==null?void 0:c.minPurchase)+"减"+a((X=y(s.couponId))==null?void 0:X.value),1)):(v(),r("span",pt,a((((Y=y(s.couponId))==null?void 0:Y.value)*10).toFixed(1))+"折 (满"+a((Z=y(s.couponId))==null?void 0:Z.minPurchase)+"可用) ",1))]),e("div",_t,"有效期至: "+a(s.expirationTime),1)]),e("div",mt,[e("input",{type:"radio",name:"coupon",checked:i.value===s.id,disabled:!L(s)},null,8,ht)])],10,it)}),128)),e("div",{class:z(["coupon-item no-coupon",{selected:i.value===null}]),onClick:o[2]||(o[2]=s=>G(null))}," 不使用优惠券 ",2),J.value.length===0&&i.value!==null?(v(),r("div",ft," 暂无可用优惠券 ")):S("",!0)])]),e("div",yt,[bt,e("div",It,[e("div",gt,[e("div",kt,[Ct,h(e("input",{type:"text","onUpdate:modelValue":o[3]||(o[3]=s=>n.value.contactName=s),placeholder:"请输入联系人姓名",required:""},null,512),[[b,n.value.contactName]])]),e("div",Nt,[xt,h(e("input",{type:"tel","onUpdate:modelValue":o[4]||(o[4]=s=>n.value.contactPhone=s),placeholder:"请输入联系电话",required:""},null,512),[[b,n.value.contactPhone]])])]),e("div",qt,[e("div",Vt,[Pt,h(e("input",{type:"email","onUpdate:modelValue":o[5]||(o[5]=s=>n.value.contactEmail=s),placeholder:"请输入联系邮箱"},null,512),[[b,n.value.contactEmail]])])]),e("div",At,[e("div",St,[Et,h(e("textarea",{"onUpdate:modelValue":o[6]||(o[6]=s=>n.value.note=s),placeholder:"请输入订单备注信息",rows:"3"},null,512),[[b,n.value.note]])])])])]),e("div",$t,[e("div",wt,[Dt,e("span",null,a($.value)+"人",1)]),e("div",Ft,[Lt,e("span",null,a(w.value)+"人",1)]),e("div",Ut,[Mt,e("span",null,"¥"+a(k.value.toFixed(2)),1)]),e("div",Tt,[zt,e("span",null,"-¥"+a(F.value.toFixed(2)),1)]),e("div",Ot,[Bt,e("span",null,"¥"+a(H.value.toFixed(2)),1)]),e("button",{class:"pay-button",onClick:se,disabled:!K.value}," 去支付 ",8,Rt)])])}}}),Zt=le(Gt,[["__scopeId","data-v-71793b05"]]);export{Zt as default};
